<html>
<head>
   <meta charset="utf-8">
   <meta name="viewport" content="initial-scale=1.0, user-scalable=no, minimal-ui" />
   <meta name="apple-mobile-web-app-title" content="Bus info" />
   <meta name="apple-mobile-web-app-capable" content="yes">
   <title>Bus info</title>
   <link href='http://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css' />
   <link href='/bus/style.css' rel='stylesheet' type='text/css' />
</head>
<body onload="initialize();">
   <div id="content">
       <div id="notifications"></div>
       <div id="stop" class="hidden">
          <h3></h3>
          <ul class="tabs">
              <li data-bind="gps" class="gps selected"></li>
              <li data-bind="departures" class="departures"></li>
              <li data-bind="lines" class="lines"></li>
          </ul>
          <table id="gps"></table>
          <table id="departures" class="hidden"></table>
          <table id="lines" class="hidden"></table>
       </div>
       <input id="map-search" class="map-search" type="text" placeholder="search term / line number" style="visibility: hidden" />
       <div id="map-canvas"><p class="spinner"></p></div>
       <div id="mapchange" class="hideAnimated" title="Change map type">
          <img data-target="google" src="/bus/google.png" />
          <img data-target="bing" class="selected" src="/bus/bing.png" />
       </div>

       <div id="templates" style="display: none;">
          <table>
              <tr data-bind="noDepartureData"><td><em>no departure data</em></td></tr>
              <tr data-bind="spinner"><th class="spinner">&nbsp;</th></tr>
              <tr data-bind="etd"><th data-bind="code"></th><td data-bind="time"></td><td data-bind="estimate"><em>(<span></span>min)</em></td></tr>
              <tr data-bind="noLineData"><td><em>no line data</em></td></tr>
              <tr data-bind="showLine">
                  <td class="code"><a href="#showLine" onclick="updateLineRoute(this.textContent, maps, state.mapState)"></a></td>
                  <td class="text"></td>
              </tr>
          </table>
          <div data-bind="pacItem" class="bus pac-item" onmousedown="centerToBusMarker(this.getElementsByTagName('span')[0].getAttribute('data-marker'), maps, state.mapState)" onmouseup="document.getElementById('map-search').blur()">
            <img src="" data-bind="icon" />
            <span class="pac-item-query" data-bind="content"></span>
            <br />
            <span data-bind="description"></span>
          </div>
       </div>
    </div>

   <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
   <script type="text/javascript" src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
   <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1HE7ysGzolLTIP3ZN1JBDmsfbFh54NeY&sensor=true&libraries=places"></script>
   <script charset="UTF-8" type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
   <script type="text/javascript" src="/bus/domhelper.js"></script>
   <script type="text/javascript" src="/bus/xmlhelper.js"></script>
   <script type="text/javascript" src="/bus/logger.js"></script>
   <script type="text/javascript" src="/bus/sirihelper.js"></script>
   <script type="text/javascript" src="/bus/cgihelper.js"></script>
   <script type="text/javascript" src="/bus/gmapshelper.js"></script>
   <script type="text/javascript" src="/bus/bingmapshelper.js"></script>
   <script type="text/javascript" src="/bus/uihelper.js"></script>
   <script type="text/javascript" src="/bus/messaginghelper.js"></script>
   <script type="text/javascript">
      var tklConfig = {
          url: 'http://lahteenmaki.net/xdm?http://api.publictransport.tampere.fi/1_0_2/',
          username: 'businfo',
          password: 'businfo'
      }
      var hslConfig = {
          url: 'http://lahteenmaki.net/xdm?http://api.reittiopas.fi/hsl/prod/',
          username: 'businfo',
          password: 'businfo'
      }
      var siriConfig = {
          application_id: 'businfo',
          url: 'http://lahteenmaki.net/xdm?https://siri.ij2010.tampere.fi/ws',
          username: 'its_factory_temp',
          password: 'ITS4devN'
      }
      var siriRTConfig = {
          url: 'http://lahteenmaki.net/xdm?http://data.itsfactory.fi/siriaccess/vm/json'
      }
      var tampereCoordinates = {latitude: 61.4981, longitude: 23.760};
      var helsinkiCoordinates = {latitude: 60.1675763, longitude: 24.9417421}

      var messageUpdateIntervalMs = 1000*60*5;
      var busUpdateIntervalMs = 1000*5;
      var stopUpdateIntervalMs = 1000*30;

      var state = {
          myLocation: null,
          followMe: true,
          
          lastFetchedLocation: null,
          
          mapState: {
            selectedBus: null,
            selectedStop: null,
            busMarkers: {},
            stopMarkers: {},
            lineShapes: [],
            stopsFetchedFor: [],
            me: null
          },
          
          updatingBuses: false,
          shownMessages: {}
      };

      var icons = {
          number: function(num) {
              return '/bus/icons/number_' + num + '.png';
          },
          stop: '/bus/icons/busstop.png'
      };
      var distanceBetween = function(coord1, coord2) {
          return Math.sqrt(Math.pow(coord1.latitude - coord2.latitude, 2) + Math.pow(coord1.longitude - coord2.longitude, 2));
      };
      var nearerToTampere = function(loc) {
          var dTampere = distanceBetween(loc, tampereCoordinates);
          var dHelsinki = distanceBetween(loc, helsinkiCoordinates);
          return dTampere < dHelsinki;
      };

      var dom = domhelper();
      var xml = xmlhelper();
      var logger = logger();
      var ui = uihelper();

      var body = function() {return dom.process(document.getElementById('content')); };
      var templates = body().templates;

      var maps;
      var messaging = messaginghelper(body().notifications(), ui);

      var siriAPI = sirihelper(xml, logger, siriConfig);
      var tklAPI = cgihelper(logger, tklConfig);
      var hslAPI = cgihelper(logger, hslConfig);
      var busAPI = function() {
          return nearerToTampere(maps.center()) ? tklAPI : hslAPI;
      };
      // itsfactory published all-vehicles RT data also as a separate json service...
      var siriRTAPI = {
          get: function(onSuccess) {
            $.ajax({
                url: siriRTConfig.url,
                dataType: 'json',
                contentType: 'application/json;charset=utf-8',
                timeout: 7500,
                success: function(d) {
                    logger.log('Received Siri JSON');
                    onSuccess(d);
                }
            });
          }
      };

      body().stop.tabs.li.forEach(function(_) {
          _().onclick = function(e) {
              if (!this.classList.contains('selected')) {
                  var selected = body().stop.tabs.selected();
                  selected.classList.remove('selected');
                  this.classList.add('selected');
                  ui.hide(document.getElementById(selected.dataset.bind));
                  ui.show(document.getElementById(this.dataset.bind));
                  updateStopBuses(state.mapState.selectedStop);
              }
          };
      });

      var updateLineRoute = function(code, maps, mapState) {
          mapState.lineShapes.forEach(maps.remove);
          busAPI().get(busAPI().LINES, {p: '10000001', query: code}, function(json) {
              json = json == '' ? [] : json;
              mapState.lineShapes = json.filter(function(_) {return _.code == code;}).map(function(_) {
                  var coords = busAPI().parseLineShape(_.line_shape);
                  logger.log('Drawing polyline of length: ' + coords.length);
                  return maps.newPolyline(coords);
              });
          });
          return false;
      }

      var updateStopBuses = function(code) {
          var updateStopDepartures = function() {
              body().stop.departures().innerHTML = templates.table.tbody.spinner({});
              busAPI().get(busAPI().STOP, {p: '00000000001', code: code}, function(json) {
                  json = json instanceof Array ? json[0] : json;
                
                  if (!json.departures || json.departures.length == 0) {
                      body().stop.departures().innerHTML = templates.table.tbody.noDepartureData({});
                  } else {
                      var rows = json.departures.map(function (_) {
                          var stamp = busAPI().parseDate(_.date);
                          var time = busAPI().parseTime(_.time);
                          stamp.setHours(time.hours);
                          stamp.setMinutes(time.minutes);
                          var now = new Date();
                          var etd = Math.floor((stamp - now)/1000/60 + time.days*24*60);
                          etd = etd < 0 ? 0 : etd;
                          return templates.table.tbody.etd({
                              code: _.code,
                              time: time.toString(),
                              estimate: {
                                  em: {
                                      span: etd
                                  }
                              }
                          });
                      });
                      body().stop.departures().innerHTML = rows.join('');
                  }
              });
          };

          var updateStopGPS = function() {
              body().stop.gps().innerHTML = templates.table.tbody.spinner({});
              siriAPI.get(siriAPI.STOP(code), function(_) {
                  var visits = _.Siri.ServiceDelivery.StopMonitoringDelivery.MonitoredStopVisit;
                  if (!visits) {
                      body().stop.gps().innerHTML = templates.table.tbody.noDepartureData({});
                  } else {
                      visits = visits instanceof Array ? visits : [visits];
                      var rows = visits.map(function(_) {
                          var lineRef = _.MonitoredVehicleJourney.LineRef;
                          var origin = _.MonitoredVehicleJourney.OriginName;
                          var destination = _.MonitoredVehicleJourney.DestinationName;
                          var vehicleRef = _.MonitoredVehicleJourney.VehicleRef;

                          var stamp = new Date(_.MonitoredVehicleJourney.MonitoredCall.ExpectedDepartureTime);
                          var now = new Date();
                          var etd = Math.floor((stamp.getTime() - now.getTime())/1000/60);
                          
                          return templates.table.tbody.etd({
                              code: lineRef,
                              time: stamp.getHours() + ':' + stamp.getMinutes(),
                              estimate: {
                                  em: {
                                      span: etd
                                  }
                              }
                          });
                      });
                      body().stop.gps().innerHTML = rows.join('');
                  }
              });
          };

          var updateStopLines = function() {
              body().stop.lines().innerHTML = templates.table.tbody.spinner({});
              busAPI().get(busAPI().STOP, {p: '0000001', code: code}, function(json) {
                  json = json instanceof Array ? json[0] : json;

                  if (!json.lines || json.lines.length == 0) {
                      body().stop.lines().innerHTML = templates.table.tbody.noLineData({});
                  } else {
                      var rows = json.lines.map(function(_) {
                          var lineCode = _.substr(0, _.indexOf(':'));
                          var route = _.substr(_.indexOf(':')+1); 
                          return templates.table.tbody.showLine({
                              code: {
                                  a: lineCode
                              },
                              text: route
                          });
                      });
                      body().stop.lines().innerHTML = rows.join('');
                  }
              });
          };

          if (ui.visible(body().stop.departures())) {
              updateStopDepartures();
          }
          if (ui.visible(body().stop.gps())) {
              updateStopGPS();
          }
          if (ui.visible(body().stop.lines())) {
              updateStopLines();
          }
      };

      var updateNearByBusStops = function(maps, mapState, lastFetchedLocation) {
          var bounds = maps.bounds();
          if (!bounds)
              return lastFetchedLocation;
          var bbox = [bounds[0].longitude, bounds[0].latitude, bounds[1].longitude, bounds[1].latitude].join(',');
          var center = maps.center();
          if (lastFetchedLocation == null || mapState.stopsFetchedFor.indexOf(bbox) == -1 && shouldFetchStops(bounds, lastFetchedLocation, center)) {
              mapState.stopsFetchedFor.push(bbox);
              busAPI().get(busAPI().STOPS_AREA, {limit: 500, center_coordinate: center.longitude + ',' + center.latitude, diameter: 2000}, function(json) {
                  json = json == '' ? [] : json;
                  var opts = {icon: icons.stop};
                  if (json.length > 10)
                      opts.animation = null; // iOS7 crashes with many simultaneous GMaps animations...
                  json.forEach(function(stop) {
                      if (!mapState.stopMarkers[stop.code]) {
                          var coords = busAPI().parseCoordinates(stop.coords);
                          var stopMarker = maps.newMarker(stop.code + ' ' + stop.name, coords, opts);

                          var stopClicked = function(e) {
                              if (e.stop) e.stop();
                              if (mapState.selectedStop) {
                                  maps.stopAnimation(mapState.stopMarkers[mapState.selectedStop]);
                                  if (mapState.selectedStop == stop.code) {
                                      mapState.selectedStop = undefined;
                                      ui.hideAnimated(body().stop());
                                      return;
                                  }
                              }
                              mapState.selectedStop = stop.code;
                              maps.animate(stopMarker);
                              body().stop.H3().innerHTML = stop.code + ' ' + stop.name;
                              ui.show(body().stop());
                              messaging.addInfoOnce('Swipe right to hide stop info.');
                              updateStopBuses(stop.code);
                          };

                          stopMarker.code = stop.code;
                          mapState.stopMarkers[stop.code] = stopMarker;
                          maps.on(maps.events.marker.CLICK, stopMarker, stopClicked);
                      }
                  });
              });
          }
          return center;
      };

      var within = function(coords, bounds) {
          var sw = bounds[0];
          var ne = bounds[1];
          return coords.latitude >= sw.latitude && coords.latitude <= ne.latitude &&
                 coords.longitude >= sw.longitude && coords.longitude <= ne.longitude;
      };

      var updateBuses = function(maps, mapState) {
          if (nearerToTampere(maps.center()) /* don't bother trying in other cities... */) {
              siriRTAPI.get(function(_) {
                  var delivery = _.Siri.ServiceDelivery.VehicleMonitoringDelivery;
                  if (!(delivery instanceof Array))
                      delivery = [delivery];
                  delivery.forEach(function(_) {
                      var activity = _.VehicleActivity;
                      if (!(activity instanceof Array))
                          activity = [activity];
                      activity.forEach(function(_) {
                          var vehicle = _.MonitoredVehicleJourney.VehicleRef.value;
                          var line = _.MonitoredVehicleJourney.LineRef.value;
                          var coords = _.MonitoredVehicleJourney.VehicleLocation;
                          var busMarker = mapState.busMarkers[vehicle];

                          if (!busMarker) {
                              var direction = _.MonitoredVehicleJourney.DirectionRef.value;
                              var origin = _.MonitoredVehicleJourney.OriginName.value;
                              var destination = _.MonitoredVehicleJourney.DestinationName.value;

                              var busClicked = function() {
                                  if (mapState.selectedBus) {
                                      maps.stopAnimation(mapState.busMarkers[mapState.selectedBus]);
                                      if (mapState.selectedBus == vehicle) {
                                          mapState.selectedBus = undefined;
                                          return;
                                      }
                                  }
                                  state.followMe = false;
                                  maps.animate(busMarker);
                                  mapState.selectedBus = vehicle;
                                  messaging.addInfo('Line ' + line + ': ' + origin + ' -> ' + destination);
                                  updateLineRoute(line + ' ' + direction, maps, mapState);
                              };

                              logger.log('Adding bus ' + vehicle + ' to: ' + coords);
                              busMarker = maps.newMarker(origin + ' -> ' + destination, coords, {icon: icons.number(line.replace(/[^0-9]/g, '')), zIndex: 500});
                              busMarker.line = line;
                              mapState.busMarkers[vehicle] = busMarker;
                              maps.on(maps.events.marker.CLICK, busMarker, busClicked);
                          } else {
                              var bounds = maps.bounds();
                              if (bounds && within(coords, bounds) || within(maps.position(busMarker), bounds)) {
                                  console.log('Moving bus ' + line);
                                  maps.moveMarker(busMarker, coords);
                                  if (!state.followMe && vehicle == mapState.selectedBus)
                                      maps.centerTo(coords);
                              }
                          }
                      });
                  });
              });
          }
      };

      var showMessage = function(_) {
          var recordedAt = new Date(_.RecordedAtTime);
          var validUntil = new Date(_.ValidUntilTime);
          var text = _.Content;
          var validMs = validUntil.getTime() - (new Date()).getTime();
          
          messaging.addWarn(recordedAt.toLocaleDateString() + ' ' + recordedAt.toLocaleTimeString() + ': ' + text, {
            delayMs: Math.min(validMs, messageUpdateIntervalMs)
          });
      };
      var updateMessages = function(shownMessages) {
          siriAPI.get(siriAPI.ALL_MESSAGES(), function(_) {
              var msgs = _.Siri.ServiceDelivery.GeneralMessageDelivery.GeneralMessage;
              if (msgs && !(msgs instanceof Array))
                  msgs = [msgs];
              (msgs || []).forEach(function(_) {
                  var msgId = _.InfoMessageIdentifier;
                  if (!shownMessages[msgId]) {
                      showMessage(_);
                      shownMessages[msgId] = true;
                  }
              });
          });
      };

      var shouldFetchStops = function(mapBounds, c1, c2) {
          var width = mapBounds[1].longitude - mapBounds[0].longitude;
          var height = mapBounds[1].latitude - mapBounds[0].latitude;
          var dx = Math.abs(c1.longitude - c2.longitude);
          var dy = Math.abs(c1.latitude - c2.latitude);
          return c1.longitude == c2.longitude && c1.latitude == c2.latitude || dx > width/10.0 || dy > height / 10.0;
      };

      var updateLocation = function(loc, oldLoc, maps, mapState, followMe) {
          logger.log("updateLocation: " + JSON.stringify(loc));
          if (oldLoc == null || loc.accuracy < oldLoc.accuracy || loc.timestamp - oldLoc.timestamp > 1000) {
              state.myLocation = loc;
              maps.moveMarker(mapState.me, loc.coords);
              if (followMe)
                  maps.centerTo(loc.coords);
          }
      };

      var centerToBusMarker = function(i, maps, mapState) {
          maps.centerTo(maps.position(mapState.busMarkers[i]));
      };

      var locationError = function(e) {
          switch(e.code) {
              case e.TIMEOUT: {
                  logger.log(e);
                  break;
              }
              default: messaging.addError(JSON.stringify(e));
          }
      };

      $(body().stop()).on('swipe', function() {
          ui.hideAnimated(body().stop());
          var selectedStop = state.mapState.stopMarkers[state.mapState.selectedStop];
          if (selectedStop)
              maps.stopAnimation(selectedStop);
          state.mapState.selectedStop = undefined;
      });

      var distanceKm = function(point1, point2) {
        var deg2rad = function(deg) {
          return deg * (Math.PI/180)
        }

        var dLat = deg2rad(point2.latitude-point1.latitude);
        var dLon = deg2rad(point2.longitude-point1.longitude); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(point1.latitude)) * Math.cos(deg2rad(point2.latitude)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        return 6371 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      var initMaps = function(type, initialLocation) {
          var maps;
          if (type == 'google') {
              maps = gmapshelper(document.getElementById('map-canvas'), document.getElementById('map-search'));
              maps.centerTo(initialLocation);
          } else if (type == 'bing') {
              maps = bingmapshelper(body()['map-canvas'](), {map: {center: initialLocation, credentials: 'Aji7Whwv3vWGwS2X4HAqZTWJjF0z159P1yOBHxzXqa7Ri6zOG_NefNXuQLCKPhHj'}});
          }

          var mapState = {
            selectedBus: state.mapState.selectedBus,
            selectedStop: state.mapState.selectedStop,
            busMarkers: {},
            stopMarkers: {},
            lineShapes: [],
            stopsFetchedFor: [],
            me: maps.newMarker("That's me there!", {latitude: 0, longitude: 0}, {zIndex: 1000})
          };

          var nearByStopUpdater = function() {
            state.lastFetchedLocation = updateNearByBusStops(maps, mapState, state.lastFetchedLocation);
          };
          maps.on(maps.events.map.BOUNDS_CHANGED, maps, nearByStopUpdater);
          maps.on(maps.events.map.ZOOM_CHANGED, maps, nearByStopUpdater);
          setTimeout(nearByStopUpdater, 1000);

          maps.on(maps.events.marker.CLICK, mapState.me, function() {
            state.followMe = true;
            maps.centerTo(state.myLocation.coords);
          });
          maps.on(maps.events.map.DRAG_START, maps, function() {
            state.followMe = false;
            messaging.addInfoOnce("Click self marker to follow own location.");
          });

          var distance = function(a,b) {
            return Math.sqrt(Math.pow(b.latitude - a.latitude, 2) + Math.pow(b.longitude - a.longitude, 2));
          };

          maps.on(maps.events.search.CHANGED, maps, function() {
            var str = maps.searchString();
            var ownLocation = state.myLocation ? state.myLocation.coords : undefined;
            var pacContainer = document.getElementsByClassName('pac-container')[0];
            $('[data-bind="pacItem"]', pacContainer).remove();
            if (str != '' && ownLocation) {
              var matchingBuses = [];
              for (var p in mapState.busMarkers)
                if (mapState.busMarkers[p].line == str || mapState.busMarkers[p].line.replace(/\D/g,'') == str)
                  matchingBuses.push(p);
              
              matchingBuses.sort(function(a,b) {
                return distance(ownLocation, maps.position(mapState.busMarkers[a])) - distance(ownLocation, maps.position(mapState.busMarkers[b]));
              });
              if (matchingBuses.length > 0) {
                state.followMe = false;
                var pacItems = matchingBuses.map(function(_) {
                  var marker = mapState.busMarkers[_];
                  var distanceToSelf = distanceKm(ownLocation, maps.position(marker));
                  var distanceHumanReadable = distanceToSelf > 1.0 ? (Math.round(distanceToSelf*10)/10) + 'km' : Math.round(distanceToSelf*1000) + 'm';
                  return templates.pacItem({icon: '', content: marker.title, description: distanceHumanReadable}, {content: {'data-marker': _}, icon: {src: marker.icon}});
                });
                pacItems.forEach(function(_) {
                  $(pacContainer).prepend(_);
                });
              }
            }
          });

          return {
            mapState: mapState,
            maps: maps
          };
      };

      body().mapchange().onclick = function() {
          var selected = body().mapchange.selected();
          var newMaps = initMaps(selected.getAttribute('data-target'), maps.center());
          newMaps.maps.zoomTo(maps.zoom());

          body().mapchange.img.forEach(function(_) {
              _().classList.add('selected');
          });
          selected.classList.remove('selected');
          maps = newMaps.maps;
          state.mapState = newMaps.mapState;
      };

      var initialize = function() {
          messaging.addInfoOnce('Bus stop data for Tampere/Helsinki.<br>Real-time data for Tampere.<br>Thanks for the icons: http://mapicons.nicolasmollet.com/', {delayMs: 3000, escape: false});

          setTimeout(function() {
              ui.show(body().mapchange());
          }, 2000);
          setTimeout(function() {
              messaging.addInfoOnce('Change map type from the bottom of the screen');
          }, 4000);

          var newMaps = initMaps('google', tampereCoordinates);
          maps = newMaps.maps;
          state.mapState = newMaps.mapState;

          var locationUpdater = function(loc) {
              updateLocation(loc, state.myLocation, maps, state.mapState, state.followMe);
              state.myLocation = loc;
          };
          navigator.geolocation.getCurrentPosition(locationUpdater, locationError, {maximumAge:Infinity, timeout:0});
          navigator.geolocation.watchPosition(locationUpdater, locationError);
          navigator.geolocation.watchPosition(locationUpdater, locationError, {enableHighAccuracy: true});

          var messageUpdater = function() {
              updateMessages(state.shownMessages);
          };
          setInterval(messageUpdater, messageUpdateIntervalMs);
          
          var busUpdater = function() {
              updateBuses(maps, state.mapState);
          };
          setTimeout(function() { setInterval(busUpdater, busUpdateIntervalMs); busUpdater(); }, 1000);

          setTimeout(function() {
              var mapState = state.mapState;
              if (mapState.selectedStop) {
                  updateStopBuses(mapState.stopMarkers[mapState.selectedStop].code);
              }
          }, stopUpdateIntervalMs);
      }
    </script>
</body>
</html>
